name: Maintenance Agent

on:
  schedule:
    - cron: "7 */6 * * *"   # every 6 hours
  workflow_dispatch:        # allow manual runs

jobs:
  run-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dev Deps
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt || true
          pip install -r requirements-dev.txt
          npm --prefix frontend ci || true

      - name: Start DB
        run: docker compose -f docker-compose.ci.yml up -d
       
      - name: Lint, Typecheck, Test, Build, Smoke
        run: |
          make verify

      - name: Stop DB
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v

      - name: Open issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Maintenance Agent failed on ${new Date().toISOString()}`;
            const body = `Automated maintenance run failed.\n\nCheck workflow logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title, body, labels: ['agent','maintenance','ci-failure']
            });

